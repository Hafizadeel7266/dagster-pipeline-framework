# Sync a specific folder from this repo to another repo when a tag is created.
# - Triggers on any tag push
# - Verifies the tag's commit is reachable from origin/main
# - Copies SOURCE_FOLDER -> TARGET_REPO:TARGET_BRANCH at TARGET_FOLDER_PATH
# - IMPORTANT: This workflow NEVER wipes the target repo. It only replaces the specified target folder.
#
# Before using:
# 1) Add a repository secret named TARGET_REPO_PAT (PAT with repo write access to the target repo).
# 2) Update TARGET_REPO to "owner/target-repo" (e.g., Hafizadeel7266/Pinwheel_Repository).
# 3) Confirm TARGET_BRANCH (e.g., "dev").
# 4) Set SOURCE_FOLDER to the folder in this repo (e.g., "Data-Pipeline").
# 5) Set TARGET_FOLDER_PATH to the folder path in the target repo you want replaced.
#    - If you want the folder placed at the root under the same folder name, set TARGET_FOLDER_PATH to "." (the workflow will map "." to the SOURCE_FOLDER name).
#    - Example: SOURCE_FOLDER="Data-Pipeline", TARGET_FOLDER_PATH="." -> the content will be written to "Data-Pipeline/" in the target repo root.
name: Sync folder to target repo on tag

on:
  push:
    tags:
      - '*'

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: "Hafizadeel7266/Pinwheel_Repository"
      TARGET_BRANCH: "dev"
      SOURCE_FOLDER: "Data-Pipeline"
      TARGET_FOLDER_PATH: "."    # use "." to mean "create/replace folder with same name as SOURCE_FOLDER at repo root"
    steps:
      - name: Checkout source repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set tag and commit env vars
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "COMMIT=$GITHUB_SHA" >> $GITHUB_ENV
          echo "SOURCE_FOLDER=${SOURCE_FOLDER}" >> $GITHUB_ENV
          echo "TARGET_FOLDER_PATH=${TARGET_FOLDER_PATH}" >> $GITHUB_ENV

      - name: Verify tag commit is reachable from origin/main
        run: |
          git fetch origin main
          if git merge-base --is-ancestor "$COMMIT" origin/main; then
            echo "Commit $COMMIT is on origin/main (proceeding)"
          else
            echo "Commit $COMMIT is NOT reachable from origin/main â€” stopping"
            exit 1
          fi

      - name: Prepare files to sync (verify SOURCE_FOLDER exists)
        run: |
          echo "Looking for source folder: '${SOURCE_FOLDER}'"
          if [ -d "${SOURCE_FOLDER}" ]; then
            SRC_PATH="${SOURCE_FOLDER}"
          elif [ -d "$(echo "${SOURCE_FOLDER}" | tr '[:upper:]' '[:lower:]')" ]; then
            SRC_PATH="$(echo "${SOURCE_FOLDER}" | tr '[:upper:]' '[:lower:]')"
          else
            echo "Source folder '${SOURCE_FOLDER}' does not exist. Listing repository root for debugging:"
            ls -la
            exit 1
          fi
          echo "Using source path: $SRC_PATH"
          rm -rf /tmp/sync
          mkdir -p /tmp/sync
          rsync -a --delete "$SRC_PATH"/ /tmp/sync/

      - name: Clone target repository and replace target folder only
        env:
          PAT: ${{ secrets.TARGET_REPO_PAT }}
        run: |
          set -euo pipefail

          if [ -z "${PAT:-}" ]; then
            echo "TARGET_REPO_PAT secret is not set. Exiting."
            exit 1
          fi

          echo "Cloning target repo https://github.com/${TARGET_REPO}.git"
          git clone "https://x-access-token:${PAT}@github.com/${TARGET_REPO}.git" target-repo
          cd target-repo

          # ensure branch exists or create it
          if git ls-remote --exit-code --heads origin "${TARGET_BRANCH}"; then
            git checkout "${TARGET_BRANCH}"
            git pull origin "${TARGET_BRANCH}"
          else
            git checkout -b "${TARGET_BRANCH}"
          fi

          # Determine the final target path to replace.
          # If TARGET_FOLDER_PATH is "." or "/", map it to the SOURCE_FOLDER name (so we don't wipe the repo).
          if [ "${TARGET_FOLDER_PATH}" = "." ] || [ "${TARGET_FOLDER_PATH}" = "/" ]; then
            FINAL_TARGET_PATH="${SOURCE_FOLDER}"
            echo "TARGET_FOLDER_PATH is root; mapping to folder '${FINAL_TARGET_PATH}' in target repo"
          else
            FINAL_TARGET_PATH="${TARGET_FOLDER_PATH}"
            echo "Using explicit TARGET_FOLDER_PATH: ${FINAL_TARGET_PATH}"
          fi

          # Remove only the target folder and replace with new content.
          echo "Replacing target folder: '${FINAL_TARGET_PATH}'"
          rm -rf "${FINAL_TARGET_PATH}"
          mkdir -p "$(dirname "${FINAL_TARGET_PATH}")" || true
          mkdir -p "${FINAL_TARGET_PATH}"
          cp -r /tmp/sync/. "${FINAL_TARGET_PATH}/"

          # Show a quick status for debugging
          echo "Status of target repo after copying:"
          ls -la "${FINAL_TARGET_PATH}" || echo "target folder missing"

          # commit only if there are changes
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit in target repo."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Sync ${SOURCE_FOLDER} from ${GITHUB_REPOSITORY} at tag ${TAG} -> ${FINAL_TARGET_PATH}"
          git push "https://x-access-token:${PAT}@github.com/${TARGET_REPO}.git" "${TARGET_BRANCH}"
