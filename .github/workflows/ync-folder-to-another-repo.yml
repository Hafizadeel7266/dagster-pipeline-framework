# Sync a specific folder from this repo to another repo when a tag is created.
# Safety: this workflow will ONLY remove and replace a single folder in the target repo.
# It will never wipe the repo root. TARGET_FOLDER_PATH can include a trailing slash (e.g. "Pipeline/")
# and will be normalized to remove the trailing slash before any remove operation.
#
# BEFORE USING:
# - Add a secret TARGET_REPO_PAT (PAT with write access to the target repo) in the source repo.
# - Update TARGET_REPO and TARGET_BRANCH if different.
# - SOURCE_FOLDER is the folder in this repo to copy (e.g. "Data-Pipeline").
# - TARGET_FOLDER_PATH is the folder in the target repo to replace (e.g. "Pipeline/" or "some/path/Folder").
name: Sync folder to target repo on tag

on:
  push:
    tags:
      - '*'

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: "Hafizadeel7266/Pinwheel_Repository"
      TARGET_BRANCH: "dev"
      SOURCE_FOLDER: "Data-Pipeline"
      TARGET_FOLDER_PATH: "Pipeline/"    # user-specified; trailing slash will be handled
    steps:
      - name: Checkout source repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set tag and commit env vars
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "COMMIT=$GITHUB_SHA" >> $GITHUB_ENV

      - name: Verify tag commit is reachable from origin/main
        run: |
          git fetch origin main
          if git merge-base --is-ancestor "$COMMIT" origin/main; then
            echo "Commit $COMMIT is on origin/main (proceeding)"
          else
            echo "Commit $COMMIT is NOT reachable from origin/main — stopping"
            exit 1
          fi

      - name: Prepare files to sync (verify SOURCE_FOLDER exists)
        run: |
          echo "Looking for source folder: '${{ env.SOURCE_FOLDER }}'"
          if [ -d "${{ env.SOURCE_FOLDER }}" ]; then
            SRC_PATH="${{ env.SOURCE_FOLDER }}"
          elif [ -d "$(echo "${{ env.SOURCE_FOLDER }}" | tr '[:upper:]' '[:lower:]')" ]; then
            SRC_PATH="$(echo "${{ env.SOURCE_FOLDER }}" | tr '[:upper:]' '[:lower:]')"
          else
            echo "Source folder '${{ env.SOURCE_FOLDER }}' does not exist. Listing repository root for debugging:"
            ls -la
            exit 1
          fi
          echo "Using source path: $SRC_PATH"
          rm -rf /tmp/sync
          mkdir -p /tmp/sync
          rsync -a --delete "$SRC_PATH"/ /tmp/sync/

      - name: Clone target repository and replace only the specified target folder (safe)
        env:
          PAT: ${{ secrets.TARGET_REPO_PAT }}
        run: |
          set -euo pipefail

          if [ -z "${PAT:-}" ]; then
            echo "TARGET_REPO_PAT secret is not set. Exiting."
            exit 1
          fi

          echo "Cloning target repo https://github.com/${TARGET_REPO}.git"
          git clone "https://x-access-token:${PAT}@github.com/${TARGET_REPO}.git" target-repo
          cd target-repo

          # ensure branch exists or create it
          if git ls-remote --exit-code --heads origin "${TARGET_BRANCH}"; then
            git checkout "${TARGET_BRANCH}"
            git pull origin "${TARGET_BRANCH}"
          else
            git checkout -b "${TARGET_BRANCH}"
          fi

          # Normalize TARGET_FOLDER_PATH: remove trailing slash if present
          RAW="${TARGET_FOLDER_PATH:-}"
          FINAL_TARGET_PATH="${RAW%/}"

          # If user set "." or empty, map to SOURCE_FOLDER (safe mapping)
          if [ -z "${FINAL_TARGET_PATH}" ] || [ "${FINAL_TARGET_PATH}" = "." ]; then
            FINAL_TARGET_PATH="${SOURCE_FOLDER}"
            echo "TARGET_FOLDER_PATH was empty or '.' — mapping to '${FINAL_TARGET_PATH}'"
          else
            echo "Normalized target folder path: '${FINAL_TARGET_PATH}'"
          fi

          # Safety checks before removing anything:
          # - must not be absolute path (no leading /)
          # - must not reference .git
          # - must not contain ".." segments
          if [[ "${FINAL_TARGET_PATH}" = /* ]]; then
            echo "ERROR: final target path is absolute. Aborting."
            exit 1
          fi
          if [[ "${FINAL_TARGET_PATH}" = *".git"* ]] || [[ "${FINAL_TARGET_PATH}" = *"/.git"* ]]; then
            echo "ERROR: final target path references .git. Aborting."
            exit 1
          fi
          if [[ "${FINAL_TARGET_PATH}" = *".."* ]]; then
            echo "ERROR: final target path contains '..'. Aborting."
            exit 1
          fi

          # Confirm current working dir is repo root (for debug)
          echo "Target repo root listing (before replace):"
          ls -la

          # Remove and replace only the exact target folder
          echo "Removing and replacing target folder: '${FINAL_TARGET_PATH}'"
          # Guard against empty expansion in rm -rf
          rm -rf -- "${FINAL_TARGET_PATH:?}"
          mkdir -p "$(dirname "${FINAL_TARGET_PATH}")" || true
          mkdir -p "${FINAL_TARGET_PATH}"
          cp -r /tmp/sync/. "${FINAL_TARGET_PATH}/"

          echo "Contents of replaced folder (after copy):"
          ls -la "${FINAL_TARGET_PATH}" || echo "target folder missing"

          # commit only if there are changes
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit in target repo."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Sync ${SOURCE_FOLDER} from ${GITHUB_REPOSITORY} at tag ${TAG} -> ${FINAL_TARGET_PATH}"
          git push "https://x-access-token:${PAT}@github.com/${TARGET_REPO}.git" "${TARGET_BRANCH}"
