# Sync a specific folder from this repo to another repo when a tag is created.
# Safety: this workflow will NOT remove other folders or wipe the target repo.
# It copies (merges) SOURCE_FOLDER into FINAL_TARGET_PATH in the target repo.
#
# To change behavior:
# - To overwrite existing files inside the target folder: use rsync -a (default below).
# - To only add new files and never overwrite existing files: use rsync -a --ignore-existing
name: Sync folder to target repo on tag

on:
  push:
    tags:
      - '*'

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: "Hafizadeel7266/Pinwheel_Repository"
      TARGET_BRANCH: "dev"
      SOURCE_FOLDER: "Data-Pipeline"
      TARGET_FOLDER_PATH: "Pipeline/"    # will be normalized to "Pipeline"
    steps:
      - name: Checkout source repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set tag and commit env vars
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "COMMIT=$GITHUB_SHA" >> $GITHUB_ENV

      - name: Verify tag commit is reachable from origin/main
        run: |
          git fetch origin main
          if git merge-base --is-ancestor "$COMMIT" origin/main; then
            echo "Commit $COMMIT is on origin/main (proceeding)"
          else
            echo "Commit $COMMIT is NOT reachable from origin/main — stopping"
            exit 1
          fi

      - name: Prepare files to sync (verify SOURCE_FOLDER exists)
        run: |
          echo "Looking for source folder: '${{ env.SOURCE_FOLDER }}'"
          if [ -d "${{ env.SOURCE_FOLDER }}" ]; then
            SRC_PATH="${{ env.SOURCE_FOLDER }}"
          elif [ -d "$(echo "${{ env.SOURCE_FOLDER }}" | tr '[:upper:]' '[:lower:]')" ]; then
            SRC_PATH="$(echo "${{ env.SOURCE_FOLDER }}" | tr '[:upper:]' '[:lower:]')"
          else
            echo "Source folder '${{ env.SOURCE_FOLDER }}' does not exist. Listing repository root for debugging:"
            ls -la
            exit 1
          fi
          echo "Using source path: $SRC_PATH"
          rm -rf /tmp/sync
          mkdir -p /tmp/sync
          rsync -a "${SRC_PATH}/" /tmp/sync/

      - name: Clone target repository and merge only the specified folder (safe)
        env:
          PAT: ${{ secrets.TARGET_REPO_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${PAT:-}" ]; then
            echo "TARGET_REPO_PAT secret is not set. Exiting."
            exit 1
          fi

          git clone "https://x-access-token:${PAT}@github.com/${TARGET_REPO}.git" target-repo
          cd target-repo

          # ensure branch exists or create it
          if git ls-remote --exit-code --heads origin "${TARGET_BRANCH}"; then
            git checkout "${TARGET_BRANCH}"
            git pull origin "${TARGET_BRANCH}"
          else
            git checkout -b "${TARGET_BRANCH}"
          fi

          # Normalize TARGET_FOLDER_PATH: remove trailing slash if present
          RAW="${TARGET_FOLDER_PATH:-}"
          FINAL_TARGET_PATH="${RAW%/}"

          # If user set "." or empty, map to SOURCE_FOLDER name (safer than root)
          if [ -z "${FINAL_TARGET_PATH}" ] || [ "${FINAL_TARGET_PATH}" = "." ]; then
            FINAL_TARGET_PATH="${SOURCE_FOLDER}"
            echo "TARGET_FOLDER_PATH was empty or '.' — mapping to '${FINAL_TARGET_PATH}'"
          else
            echo "Normalized target folder path: '${FINAL_TARGET_PATH}'"
          fi

          # Safety checks
          if [[ "${FINAL_TARGET_PATH}" = /* ]] || [[ "${FINAL_TARGET_PATH}" = *".git"* ]] || [[ "${FINAL_TARGET_PATH}" = *".."* ]]; then
            echo "ERROR: invalid FINAL_TARGET_PATH '${FINAL_TARGET_PATH}'. Aborting."
            exit 1
          fi

          # Merge copy: do NOT remove other folders. Create target folder and copy content into it.
          echo "Merging files into target folder: '${FINAL_TARGET_PATH}'"
          mkdir -p "$(dirname "${FINAL_TARGET_PATH}")" || true
          mkdir -p "${FINAL_TARGET_PATH}"
          # Option A (default) - merge and overwrite files with same name:
          rsync -a /tmp/sync/ "${FINAL_TARGET_PATH}/"

          # Option B (alternative) - only add new files, do NOT overwrite:
          # rsync -a --ignore-existing /tmp/sync/ "${FINAL_TARGET_PATH}/"

          # Show what changed (for debugging)
          echo "Status of target folder after copy:"
          ls -la "${FINAL_TARGET_PATH}" || echo "target folder missing"

          # Stage only the target folder (do NOT stage other files)
          git add -- "${FINAL_TARGET_PATH}"

          # If no staged changes, exit
          if git diff --cached --quiet; then
            echo "No changes to commit in target repo (folder was already up-to-date)."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Add/Update ${SOURCE_FOLDER} from ${GITHUB_REPOSITORY} at tag ${TAG} -> ${FINAL_TARGET_PATH}"
          git push "https://x-access-token:${PAT}@github.com/${TARGET_REPO}.git" "${TARGET_BRANCH}"
